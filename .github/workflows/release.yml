name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      release_draft:
        description: 'Create as draft release'
        required: false
        default: true
        type: boolean

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        env:
          CI: true
          GITHUB_ACTIONS: true
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Build Windows installer
        env:
          CI: true
        run: npm run dist:win

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: |
            release/build/StratoSort-Setup-*.exe
            release/build/StratoSort-*-win-*.exe

  build-mac:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        env:
          CI: true
          GITHUB_ACTIONS: true
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Build macOS installer
        env:
          CI: true
        run: npm run dist:mac

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-installer
          path: |
            release/build/*.dmg
            release/build/*.zip

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        env:
          CI: true
          GITHUB_ACTIONS: true
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Build Linux packages
        env:
          CI: true
        run: npm run dist:linux

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-packages
          path: |
            release/build/*.AppImage
            release/build/*.deb
            release/build/*.rpm

  release:
    needs: [build-windows, build-mac, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Download all artifacts
        uses: actions/download-artifact@v6
        with:
          path: release-files

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          draft: ${{ github.event.inputs.release_draft || false }}
          generate_release_notes: true
          files: |
            release-files/**/*.exe
            release-files/**/*.dmg
            release-files/**/*.zip
            release-files/**/*.AppImage
            release-files/**/*.deb
          body: |
            ## üéâ StratoSort Release

            ### üì¶ Installation

            **Windows**: Download `StratoSort-Setup-*.exe` and run the installer
            **macOS**: Download `StratoSort-*.dmg` and drag to Applications
            **Linux**: Download `StratoSort-*.AppImage`, make executable, and run

            ### ‚ú® Features
            - ü§ñ AI-powered file organization
            - üñºÔ∏è Image content analysis
            - üìÅ Smart folder suggestions
            - üîÑ Full undo/redo support
            - üîí 100% private - runs locally

            ### üìã System Requirements
            - 6GB RAM minimum
            - 6GB disk space (for AI models)
            - Windows 10/11, macOS 10.15+, or Linux

            ### üöÄ First Run
            On first launch, StratoSort will:
            1. Check for Ollama AI engine
            2. Guide you through setup if needed
            3. Download essential AI models (~6GB, one-time)

            See [Quick Start Guide](https://github.com/${{ github.repository }}/blob/main/QUICK_START.md) for detailed instructions.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
